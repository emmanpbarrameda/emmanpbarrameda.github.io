---
// src/pages/blog/index.astro
import { getCollection } from "astro:content";
import { Icon } from "astro-icon/components";
import BlogIndexShell from "../../components/blog/BlogIndexShell.astro";
import { formatDate } from "../../utils/blog";
import { infos } from "../../data/infos.js";

const base = import.meta.env.BASE_URL || "/";
const posts = (await getCollection("blog")).filter((p) => (import.meta.env.PROD ? !p.data.draft : true)).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const canonicalUrl = new URL(`${base}dev-notes/`, Astro.site).toString();

const toPublicUrl = (src?: string) => {
  if (!src) return null;
  if (src.startsWith("http")) return src;
  return `${base}${src.replace(/^\/+/, "")}`;
};
---

<BlogIndexShell pageTitle={infos.blog_page_name} pageDescription={infos.blog_page_tagline} url={canonicalUrl}>
  <header class="mt-10 space-y-3 opacity-0 intersect:opacity-100 intersect:duration-700 intersect:animate-in intersect:slide-in-from-top-10">
    <!-- icon + title on same line -->
    <div class="flex items-center gap-4">
      <a href={`${base}`} aria-label="Home" class="inline-flex items-center justify-center text-neutral-400 hover:text-sky-300 transition-colors group">
        <svg class="w-5 h-5 translate-y-[2px] transition-transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </a>

      <h1 class="text-4xl sm:text-5xl font-black tracking-tighter leading-none uppercase">
        <span class="text-sky-400">#</span>
        {infos.blog_page_name}
      </h1>
    </div>

    <!-- indent to match start of the title (w-5 + gap-4 = 20px + 16px = 36px => pl-9) -->
    <p class="pl-9 text-neutral-400 font-jetbrains font-normal"> Short write-ups on bugs, fixes, experiments, and lessons learned while coding.</p>
  </header>

  {
    posts.length === 0 ? (
      <div class="text-center py-16">
        <p class="text-neutral-500 font-jetbrains">No posts yet. Check back soon!</p>
      </div>
    ) : (
      <>
        <div class="flex items-center gap-3">
          <div class="relative flex-1">
            <input id="blog-search" type="search" placeholder="Search postsâ€¦" class="w-full rounded-xl border border-neutral-800/80 bg-neutral-950/80 px-4 py-3 pr-10 text-sm text-neutral-200 placeholder:text-neutral-600 outline-none transition focus:border-sky-500/60 focus:ring-2 focus:ring-sky-500/15" autocomplete="off" />
            <span class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-neutral-500">
              <Icon name="mdi:magnify" class="text-xl" />
            </span>
          </div>
          <span id="blog-search-count" class="text-xs text-neutral-500 whitespace-nowrap" />
        </div>
        <p id="blog-search-empty" class="hidden mt-3 text-center text-sm text-neutral-500 font-jetbrains">
          No matching posts.
        </p>

        <section class="flex flex-col gap-3.5">
          {posts.map((post, index) => (
            <a href={`${base}dev-notes/${post.id.replace(/\.(md|mdx)$/, "")}/`} data-post-card data-search={`${post.data.title} ${post.data.description ?? ""} ${(post.data.tags ?? []).join(" ")}`.toLowerCase()} class="group relative rounded-xl border border-neutral-800/60 bg-gradient-to-r from-neutral-900/80 via-neutral-900/40 to-neutral-800/20 backdrop-blur-sm transition-all duration-300 hover:border-sky-500/60 hover:bg-neutral-900/90 hover:shadow-lg hover:shadow-sky-500/10 hover:-translate-y-0.5 opacity-0 intersect:opacity-100 intersect:duration-700 intersect:animate-in intersect:slide-in-from-bottom-6" style={`animation-delay: ${index * 50}ms`}>
              <div class="absolute inset-0 rounded-xl bg-gradient-to-r from-sky-500/0 via-sky-500/5 to-cyan-500/0 opacity-0 group-hover:opacity-100 transition-opacity duration-300" />

              <div class="relative flex flex-col sm:flex-row sm:items-center gap-4 sm:gap-5 p-5">
                {/* Cover */}
                {(() => {
                  const coverSrc = toPublicUrl(post.data.cover?.src);
                  return (
                    <div class="w-full sm:w-28 md:w-32 lg:w-36 shrink-0 overflow-hidden rounded-xl border border-neutral-800/60 bg-neutral-900/40 group-hover:border-sky-500/30 transition-colors aspect-video">
                      {coverSrc ? (
                        <img src={coverSrc} alt={post.data.cover?.alt ?? post.data.title} class="h-full w-full object-cover" loading="lazy" decoding="async" />
                      ) : (
                        <div class="relative h-full w-full">
                          <div class="absolute inset-0 bg-gradient-to-br from-neutral-900/60 via-neutral-900/30 to-neutral-800/20" />
                          <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity bg-gradient-to-r from-sky-500/0 via-sky-500/10 to-cyan-500/0" />
                          <svg class="absolute left-3 top-3 h-5 w-5 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6M7 4h10a2 2 0 012 2v14l-4-2-4 2-4-2-4 2V6a2 2 0 012-2z" />
                          </svg>
                        </div>
                      )}
                    </div>
                  );
                })()}

                {/* Text */}
                <div class="min-w-0 flex-1 text-left">
                  <div class="text-base font-semibold leading-tight text-white group-hover:text-sky-50 transition-colors line-clamp-2">{post.data.title}</div>

                  {post.data.description && <div class="mt-1 text-xs text-neutral-400 line-clamp-2 group-hover:text-neutral-300 transition-colors">{post.data.description}</div>}

                  <div class="mt-3 flex flex-wrap items-center gap-x-2 gap-y-1 text-xs text-neutral-500">
                    <span>{formatDate(post.data.pubDate)}</span>

                    {post.data.tags?.slice(0, 2).map((t: string) => (
                      <span class="text-sky-400/70">#{t}</span>
                    ))}
                  </div>
                </div>

                {/* Arrow */}
                <div class="hidden sm:flex items-center text-neutral-600 group-hover:text-sky-300 transition-all duration-300 group-hover:translate-x-1">
                  <Icon name="mdi:arrow-right" class="text-xl" />
                </div>
              </div>
            </a>
          ))}
        </section>
      </>
    )
  }

  <script is:inline>
    const input = document.getElementById("blog-search");
    const cards = Array.from(document.querySelectorAll("[data-post-card]"));
    const empty = document.getElementById("blog-search-empty");
    const count = document.getElementById("blog-search-count");

    function run() {
      const q = (input.value || "").trim().toLowerCase();
      let visible = 0;

      for (const el of cards) {
        const hay = el.getAttribute("data-search") || "";
        const show = !q || hay.includes(q);
        el.classList.toggle("hidden", !show);
        if (show) visible++;
      }

      if (count) count.textContent = q ? `${visible} result${visible === 1 ? "" : "s"}` : "";
      if (empty) empty.classList.toggle("hidden", visible !== 0);
    }

    input?.addEventListener("input", run, { passive: true });
    run();
  </script>
</BlogIndexShell>
