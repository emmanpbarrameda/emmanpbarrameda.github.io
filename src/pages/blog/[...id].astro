---
// src/pages/blog/[...id].astro
import { getCollection } from "astro:content";
import BlogPostShell from "../../components/blog/BlogPostShell.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");

  return posts
    .filter((p) => (import.meta.env.PROD ? !p.data.draft : true))
    .map((post) => {
      const cleanId = post.id.replace(/\.(md|mdx)$/, "");
      return {
        params: { id: cleanId },
        props: { post, cleanId }
      };
    });
}

const { post, cleanId } = Astro.props;
const { Content } = await post.render();

const base = import.meta.env.BASE_URL || "/";
const canonicalUrl = new URL(`${base}blog/${cleanId}/`, Astro.site).toString();

const words = post.body?.trim().split(/\s+/).filter(Boolean).length ?? 0;
const readMinutes = Math.max(1, Math.round(words / 200));
---

<!-- MARK: pass all data here to BlogPostShell -->
<BlogPostShell title={post.data.title} description={post.data.description} pubDate={post.data.pubDate} tags={post.data.tags} cover={post.data.cover} url={canonicalUrl} readMinutes={readMinutes}>
  <Content />
</BlogPostShell>
