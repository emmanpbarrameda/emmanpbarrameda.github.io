---
// src/components/blog/BlogPostShell.astro
import { infos } from "../../data/infos.js";
import Footer from "../footer/footer.astro";
import Background from "../common/background.astro";
import MetaTags from "../common/meta-tags.astro";
import BackToTop from "../common/back-to-top.astro";
import { formatDate } from "../../utils/blog";
import clientGuards from "../../layouts/main-layout.js?raw";
import { getCollection } from "astro:content";
import "../../utils/blog-md-content.css";

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  tags?: string[];
  url?: string;
}

const { title, description, pubDate, tags = [], url } = Astro.props;
const base = import.meta.env.BASE_URL || "/";
const allPosts = await getCollection("blog", ({ data }) => !data.draft);
function daysSince(d: Date) {
  return (Date.now() - d.getTime()) / (1000 * 60 * 60 * 24);
}
const currentTags: string[] = tags ?? [];
const relatedPosts = allPosts
  .filter((p) => p.data.title !== title)
  .map((p) => {
    const pTags: string[] = (p.data.tags ?? []) as string[];
    const tagScore = pTags.filter((t: string) => currentTags.includes(t)).length;
    const d = new Date(p.data.pubDate);
    const diff = daysSince(d);
    const recencyBoost = diff < 30 ? 1 : diff < 90 ? 0.5 : 0;
    return { p, score: tagScore + recencyBoost };
  })
  .filter((x) => x.score > 0)
  .sort((a, b) => b.score - a.score)
  .slice(0, 3)
  .map((x) => x.p);
const latestPosts = allPosts
  .filter((p) => p.data.title !== title)
  .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime())
  .slice(0, 3);
---

<!doctype html>
<html lang="en">
  <head>
    <MetaTags title={`${title} | ${infos.subname} Blog`} description={description} url={url} />
    <title>{title} | {infos.subname}</title>
    <meta name="description" content={description} />
  </head>

  <body class="relative min-h-screen bg-neutral-950 text-white overflow-x-hidden" oncontextmenu="return false;">
    <Background />

    <!-- MARK: BLUR -->
    <div class="pointer-events-none fixed inset-0 z-0 overflow-hidden">
      <div class="absolute -top-40 -right-40 h-96 w-96 rounded-full bg-sky-500/5 blur-3xl"></div>
      <div class="absolute -bottom-40 -left-40 h-96 w-96 rounded-full bg-cyan-500/5 blur-3xl"></div>
    </div>

    <main class="relative z-10 mx-auto min-h-screen max-w-screen-xl px-4 py-12 sm:py-16">
      <div class="grid gap-10 lg:grid-cols-[240px_minmax(0,1fr)_200px]">
        <!-- MARK: DESKTOP: TOC -->
        <aside class="hidden lg:block">
          <div class="sticky top-24 rounded-lg border border-neutral-800/50 bg-neutral-900/40 backdrop-blur-sm p-4">
            <a href={`${base}blog/`} class="flex items-center gap-2 text-sm text-neutral-400 hover:text-sky-300 transition-colors group mb-4">
              <svg class="w-4 h-4 transition-transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
              Back to Menu
            </a>
            <div class="mb-4 pb-2 border-b border-neutral-800/40 text-xs uppercase tracking-[0.3em] text-neutral-500"> On This Page </div>
            <nav id="blog-toc" class="space-y-2 text-sm max-h-[65vh] overflow-y-auto overscroll-contain pr-2 [&::-webkit-scrollbar]:w-1.5 [&::-webkit-scrollbar-track]:bg-neutral-950/30 [&::-webkit-scrollbar-thumb]:bg-neutral-800 hover:[&::-webkit-scrollbar-thumb]:bg-neutral-700"></nav>

            <!-- MARK: BUTTONS TOC Desktop -->
            <div class="mt-4 pt-3 border-t border-neutral-800/40 flex items-center justify-between">
              <!-- BUTTONS: Print + Back to top -->
              <div class="flex items-center gap-2">
                <!-- BUTTON: Back to top -->
                <a href="#" class="flex items-center gap-2 text-xs text-neutral-500 hover:text-sky-300 transition-colors" aria-label="Back to top" title="Back to top">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                  </svg>
                </a>
                <!-- BUTTON: Print -->
                <button onclick="window.print()" class="flex items-center gap-2 text-xs text-neutral-500 hover:text-sky-300 transition-colors" aria-label="Print" title="Print this post">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                  </svg>
                </button>
              </div>

              <!-- BUTTONS: TTS Group -->
              <div class="flex items-center gap-2">
                <button type="button" data-tts-stop class="hidden items-center justify-center text-neutral-500 hover:text-sky-300 transition-colors" title="Stop (Esc)">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 6h12v12H6z"></path>
                  </svg>
                </button>
                <button type="button" data-tts-restart class="hidden items-center justify-center text-neutral-500 hover:text-sky-300 transition-colors" title="Restart (R)">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h4V6m0 4L4 7a9 9 0 11.5 9"></path>
                  </svg>
                </button>
                <button type="button" data-tts-toggle class="flex items-center gap-1 text-xs text-neutral-500 hover:text-sky-300 transition-colors" title="Play (Space)">
                  <svg data-tts-icon class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5v14l11-7z"></path>
                  </svg>
                  <span data-tts-label>Play</span>
                </button>
              </div>

              <!-- BUTTONS: Comment + Share -->
              <div class="flex items-center gap-2">
                <!-- BUTTON: Comment (go to #comments) -->
                <a href="#comments" class="flex items-center gap-2 text-xs text-neutral-500 hover:text-sky-300 transition-colors" aria-label="Jump to comments" title="Jump to comments">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h6m-7 9l3.5-3H20a2 2 0 002-2V6a2 2 0 00-2-2H4a2 2 0 00-2 2v10a2 2 0 002 2h2v3z"></path>
                  </svg>
                </a>
                <!-- BUTTON: Share -->
                <button type="button" data-share-post class="flex items-center gap-2 text-xs text-neutral-500 hover:text-sky-300 transition-colors" aria-label="Share this post" title="Share this post">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </aside>
        <script src={`${base}js/blog-toc.js`} defer></script>

        <!-- MARK: Main article -->
        <div class="min-w-0">
          <header class="opacity-0 intersect:opacity-100 intersect:duration-700 intersect:animate-in intersect:slide-in-from-top-10">
            <!-- MARK: MOBILE Back -->
            <a href={`${base}blog/`} class="lg:hidden inline-flex items-center gap-2 text-sm text-neutral-400 hover:text-sky-300 transition-colors group">
              <svg class="w-4 h-4 transition-transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
              Back to Menu
            </a>

            <h1 class="mt-6 text-4xl sm:text-5xl font-black tracking-tighter">
              <span class="text-sky-400">#</span>
              {title}
            </h1>
            <p class="mt-3 text-neutral-400">{description}</p>

            <div class="mt-4 flex flex-wrap items-center gap-3 text-xs text-neutral-500">
              <span class="inline-flex items-center rounded-full border border-neutral-800/60 bg-neutral-900/40 px-3 py-1">
                {formatDate(pubDate)}
              </span>
              {
                tags.length > 0 && (
                  <div class="flex flex-wrap gap-2">
                    {tags.map((t: string) => (
                      <span class="rounded-full border border-sky-500/20 bg-sky-500/5 px-3 py-1 text-sky-200/90">#{t}</span>
                    ))}
                  </div>
                )
              }
            </div>
            <hr class="mt-8 border-neutral-800/60" />
          </header>

          <!-- MARK: MOBILE TOC -->
          <div class="lg:hidden sticky top-2 z-40 mb-6">
            <div class="rounded-lg border border-neutral-800/50 bg-neutral-900/90 backdrop-blur-sm">
              <details>
                <summary class="flex items-center justify-between p-4 cursor-pointer text-sm text-neutral-400 hover:text-sky-300 transition-colors">
                  <!-- Left: TOC label -->
                  <span class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path>
                    </svg>
                    Table of Contents
                  </span>

                  <!-- Right: actions -->
                  <span class="flex items-center gap-3">
                    <!-- Comments icon -->
                    <a href="#comments" class="text-neutral-500 hover:text-sky-300 transition-colors" aria-label="Jump to comments" onclick="event.stopPropagation()">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h6m-7 9l3.5-3H20a2 2 0 002-2V6a2 2 0 00-2-2H4a2 2 0 00-2 2v10a2 2 0 002 2h2v3z"></path>
                      </svg>
                    </a>
                    <!-- Chevron -->
                    <svg class="w-4 h-4 toc-chevron transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </span>
                </summary>
                <nav id="blog-toc-mobile" class="px-4 pb-4 space-y-2 text-sm max-h-[50vh] overflow-y-auto"></nav>
              </details>
            </div>
          </div>

          <!-- MARK: .MD Data (md files inside of src\content\blog) content -->
          <article class="blog-content font-jetbrains font-light text-neutral-400 [&>p]:text-justify">
            <slot />
          </article>

          <!-- MARK: Bottom Post actions -->
          <div class="mt-8 pt-6 border-t border-neutral-800/40 flex items-center justify-center gap-6">
            <a href="#top" class="flex items-center gap-2 text-base px-3 py-2 rounded-md text-neutral-500 hover:text-sky-300 hover:bg-neutral-900/50 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
              </svg>
              Back to Top
            </a>
            <button type="button" data-share-post class="flex items-center gap-2 text-base px-3 py-2 rounded-md text-neutral-500 hover:text-sky-300 hover:bg-neutral-900/50 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
              </svg>
              Share
            </button>
          </div>

          <!-- MARK: Comments+Reaction with (https://giscus.app/) -->
          <section id="comments" class="mt-10 scroll-mt-28 rounded-xl border border-neutral-800/60 bg-neutral-900/40 p-4 sm:p-5">
            <details class="group">
              <summary class="flex cursor-pointer list-none items-center justify-between">
                <div class="flex items-center gap-3">
                  <h2 class="text-sm font-semibold tracking-wide text-neutral-200 group-hover:text-sky-300 transition-colors"> Comments & Reactions </h2>
                  <span class="text-xs text-neutral-500">(click to open)</span>
                </div>

                <svg class="h-4 w-4 text-neutral-500 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </summary>

              <div class="mt-4">
                <div class="giscus"></div>
              </div>
            </details>
            <script is:inline>
              (() => {
                const section = document.getElementById("comments");
                const details = section?.querySelector("details");
                if (!section || !details) return;

                let loaded = false;
                const load = () => {
                  if (loaded) return;
                  loaded = true;

                  const s = document.createElement("script");
                  s.src = "https://giscus.app/client.js";
                  s.async = true;
                  s.crossOrigin = "anonymous";

                  s.setAttribute("data-repo", "emmanpbarrameda/emmanpbarrameda.github.io");
                  s.setAttribute("data-repo-id", "R_kgDOJiknzg");
                  s.setAttribute("data-category", "Portfolio READS Comments");
                  s.setAttribute("data-category-id", "DIC_kwDOJiknzs4C0Qj9");
                  s.setAttribute("data-mapping", "pathname");
                  s.setAttribute("data-strict", "0");
                  s.setAttribute("data-reactions-enabled", "1");
                  s.setAttribute("data-emit-metadata", "0");
                  s.setAttribute("data-input-position", "bottom");
                  s.setAttribute("data-theme", "transparent_dark");
                  s.setAttribute("data-lang", "en");
                  section.querySelector(".giscus")?.appendChild(s);
                };

                const openIfHashMatches = () => {
                  if (location.hash !== "#comments") return;
                  details.open = true;
                  load();
                  section.scrollIntoView({ block: "start", behavior: "smooth" });
                };

                details.addEventListener("toggle", () => {
                  if (details.open) load();
                });
                openIfHashMatches();
                window.addEventListener("hashchange", openIfHashMatches);
                document.addEventListener("astro:page-load", openIfHashMatches);
              })();
            </script>
          </section>

          <!-- MARK: Related Posts -->
          {
            (relatedPosts.length > 0 || latestPosts.length > 0) && (
              <section class="mt-10">
                <div class="mb-4 flex items-center justify-between">
                  <h2 class="text-sm font-semibold tracking-wide text-neutral-200">{relatedPosts.length > 0 ? "Related posts" : "Latest posts"}</h2>
                  <div class="h-px flex-1 ml-4 bg-neutral-800/60" />
                </div>

                <div class="grid auto-rows-fr gap-4 sm:grid-cols-2 lg:grid-cols-3">
                  {(relatedPosts.length > 0 ? relatedPosts : latestPosts).map((post) => (
                    <a href={`${base}blog/${post.slug}/`} class="group relative h-full rounded-xl border border-neutral-800/60 bg-neutral-900/40 p-4 transition hover:border-neutral-700/80 hover:bg-neutral-900/60 flex flex-col">
                      {/* top content */}
                      <div>
                        <div class="text-sm font-semibold text-neutral-200 group-hover:text-sky-300 transition-colors line-clamp-2 min-h-[2.5rem]" title={post.data.title}>
                          {post.data.title}
                        </div>
                        {post.data.description && <p class="mt-2 text-xs text-neutral-400 line-clamp-2 min-h-[2.25rem]">{post.data.description}</p>}
                      </div>

                      {/* footer pinned to bottom */}
                      <div class="mt-auto pt-3 flex items-center justify-between text-[10px] text-neutral-500">
                        <span>{new Intl.DateTimeFormat("en-US", { month: "short", day: "numeric", year: "numeric" }).format(new Date(post.data.pubDate))}</span>

                        {(() => {
                          const t = (post.data.tags ?? []) as string[];
                          if (!t.length) return null;
                          const shown = t.slice(0, 1);
                          const extra = t.length - shown.length;
                          return (
                            <div class="flex items-center gap-2 flex-nowrap">
                              {shown.map((tag: string) => (
                                <span class="max-w-[110px] truncate shrink-0 rounded-full border border-sky-500/20 bg-sky-500/5 px-2 py-0.5 text-[10px] text-sky-200/90" title={tag}>
                                  #{tag}
                                </span>
                              ))}

                              {extra > 0 && <span class="shrink-0 rounded-full border border-neutral-800/60 bg-neutral-900/50 px-2 py-0.5 text-[10px] text-neutral-400">+{extra}</span>}
                            </div>
                          );
                        })()}
                      </div>
                    </a>
                  ))}
                </div>
              </section>
            )
          }

          <BackToTop />
          <script is:inline set:html={clientGuards} />
          <Footer />
        </div>
      </div>
    </main>

    <script src={`${base}js/blog-heading-copy-links.js`} defer></script>
    <script src={`${base}js/blog-share.js`} defer></script>
    <script src={`${base}js/blog-tts.js`} defer></script>
  </body></html
>
