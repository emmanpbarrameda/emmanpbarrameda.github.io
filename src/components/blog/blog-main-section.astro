---
// file: src\components\blog\blog-main-section.astro
import { getCollection } from "astro:content";
import { infos } from "../../data/infos.js";
import { formatDate } from "../../utils/blog";
import SectionTitle from "../common/section-title.astro";

const base = import.meta.env.BASE_URL || "/";

const toPublicUrl = (src?: string) => {
  if (!src) return null;
  if (src.startsWith("http")) return src;
  return `${base}${src.replace(/^\/+/, "")}`;
};

const BLOG_PREVIEW_LIMIT = 2;

const posts = (await getCollection("blog", ({ data }) => !data.draft)).sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()).slice(0, BLOG_PREVIEW_LIMIT);
---

<section class="mx-auto mt-28 max-w-screen-md px-4">
  <div class="flex flex-col items-center gap-5 text-center">
    <SectionTitle>Dev Notes</SectionTitle>
    <p class="mb-6 mx-auto max-w-[520px] text-pretty text-neutral-400">{infos.blog_page_tagline}</p>
  </div>

  <div class="mt-4 grid gap-4">
    {
      posts.map((post) => {
        const coverSrc = (post.data as any)?.cover?.src;
        const coverAlt = (post.data as any)?.cover?.alt ?? post.data.title;
        const cover = toPublicUrl(coverSrc);

        return (
          <a
            href={`${base}${infos.blog_page_slug}/${post.slug}/`}
            class="group overflow-hidden rounded-md border border-neutral-800/60 bg-neutral-900/40 p-4 transition hover:border-neutral-700/80 hover:bg-neutral-900/60
              opacity-0 intersect:opacity-100 intersect:duration-700 intersect:animate-in intersect:fade-in-0 intersect:slide-in-from-bottom-12"
          >
            {cover && (
              <div class="-m-4 mb-4 aspect-video w-[calc(100%+2rem)] border-b border-neutral-800/60 bg-neutral-950/30">
                <img src={cover} alt={coverAlt} class="h-full w-full object-cover" loading="lazy" decoding="async" />
              </div>
            )}

            <div class="text-sm font-semibold text-neutral-200 group-hover:text-sky-300 transition-colors">{post.data.title}</div>

            {(post.data.tags?.length ?? 0) > 0 && (
              <div class="mt-3 flex flex-wrap gap-2">
                {post.data.tags.slice(0, 4).map((tag: string) => (
                  <span class="rounded border border-sky-900 bg-sky-900/20 px-2 py-1 text-[11px] font-jetbrains text-sky-400">#{tag}</span>
                ))}
              </div>
            )}

            {post.data.description && <p class="mt-2 text-sm text-neutral-400 line-clamp-2">{post.data.description}</p>}

            <div class="mt-3 text-xs text-neutral-500">{formatDate(new Date(post.data.pubDate))}</div>
          </a>
        );
      })
    }
  </div>

  <!-- MARK: bottom cta -->
  <div class="mt-8 w-full text-center">
    <a href={`${base}${infos.blog_page_slug}/`} class="mx-auto inline-flex items-center justify-center gap-2 rounded-md bg-gradient-to-r from-sky-400 via-cyan-500 to-blue-600 px-6 py-3 text-center font-jetbrains font-bold text-white transition-all duration-200 hover:brightness-110 hover:scale-105 hover:shadow-lg hover:shadow-sky-400/25 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2 focus:ring-offset-gray-900">
      readMorePosts();
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
        <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
      </svg>
    </a>
  </div>
</section>
