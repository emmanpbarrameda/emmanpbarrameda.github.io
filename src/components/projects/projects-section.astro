---
import SectionTitle from "../common/section-title.astro";
import ProjectCard from "./project-card.astro";
import { Icon } from "astro-icon/components";
import { infos } from "../../data/infos.js";
import type { Tech } from "./tech-stack.astro";

const baseUrl = infos.host;

/**
 * ? STEP 1: Define allowed project types
 * These are the only valid "type" values a project can have.
 * It ensures we only process projects with one of these labels.
 */
const allowedTypes = ["BackEnd Project", "FrontEnd Project", "FullStack Project", "Client Project", "Open-Source Contribution", "Capstone Project"] as const;

type AllowedProjectType = (typeof allowedTypes)[number];

/**
 * ? STEP 2: Define valid tech stack names
 * ! These must match exactly with what's defined in the TECHS object from tech-stack.astro.
 * This ensures only recognized technologies are displayed in badges.
 */
const validTechs = ["NextJs", "Supabase", "TailwindCSS", "Bootstrap", "React", "Vite", "OOP", "Astro", "TypeScript", "Drizzle", "JavaScript", "PostgreSQL", "SQLite", "NextAuth.js", "Sorting Algorithms", "Framer Motion", "Vanilla", "SocketIO", "Laravel", "PHP", "Symfony", "FilamentPHP", "MySQL", "Git", "GitHub", "API", "REST", "MVC", "JWT", "AI", "Android", "Java"] as const;

/**
 * ? STEP 3: Project type definition
 * A strongly-typed structure representing one project.
 */
type Project = {
  type: AllowedProjectType;
  title: string;
  stack: Tech[];
  description: string;
  deploy: string;
  repository: string;
  image: string;
  alt: string;
  previews: string[];
};

/**
 * ? STEP 4: Fetch data from Google Sheets (via Apps Script)
 * The Apps Script returns JSON data from your sheet.
 * Data is published on Google Sheets using an Apps Script and returned in JSON format
 * https://drive.google.com/drive/folders/1a8QSO55RMBGsN8D8cyt8xF8t9pmkoXUJ?usp=sharing
 */
const res = await fetch("https://script.google.com/macros/s/AKfycbznRbSRlbdYjV7YcyU69xllROJfvesitII2VAT_O4Q0DYp_wlk2QHcy0iBNm5H_pkBjyQ/exec");
const rawProjects = await res.json();

/**
 * ? STEP 5: Process and validate the fetched data
 * - Only allow projects with valid types
 * - Clean and validate the tech stack array
 * - Auto-correct relative image paths using baseUrl
 */
const projects: Project[] = rawProjects
  .filter((proj: any) => allowedTypes.includes(proj.type))
  .map((proj: any) => ({
    type: proj.type as AllowedProjectType,
    title: proj.title,
    stack: proj.stack
      .split(",")
      .map((s: string) => s.trim())
      .filter((s: string): s is Tech => validTechs.includes(s as Tech)),
    description: proj.description,
    deploy: proj.deploy,
    repository: proj.repository,
    image: proj.image.startsWith("http") ? proj.image : `${baseUrl}${proj.image}`,
    alt: proj.alt,
    previews: proj.previews?.split(",").map((p: string) => (p.trim().startsWith("http") ? p.trim() : `${baseUrl}${p.trim()}`)) || []
  }));

/**
 * ? STEP 6: Limit how many project cards to show by default
 */
const PROJECT_PREVIEW_LIMIT = 4;
---

<!-- ! ========================== --><!-- SECTION: Development Projects --><!-- ========================== -->
<section id="projects" class="mx-auto mt-28 flex max-w-screen-md flex-col items-center gap-5 px-4 pt-4">
  <!-- ? Section header and intro text -->
  <SectionTitle>Development Projects</SectionTitle>
  <p class="max-w-[500px] text-center text-neutral-400">Dive into a showcase of my development projects, each a testament to my skills, creativity, and dedication to development.</p>

  <!-- ? List of project cards (from fetched & filtered sheet data) -->
  <div class="mt-3 flex flex-col gap-8">
    {
      projects.map((project, index) => (
        <div class="project-item" data-preview={index < PROJECT_PREVIEW_LIMIT ? "true" : "false"}>
          <ProjectCard type={project.type} title={project.title} stack={project.stack} description={project.description} deploy={project.deploy} repository={project.repository} image={project.image} alt={project.alt} className={`intersect:slide-in-from-${index % 2 === 0 ? "left" : "right"}-12`} previews={project.previews} />
        </div>
      ))
    }
  </div>

  <!-- ? Show all / Show less button -->
  {
    projects.length > PROJECT_PREVIEW_LIMIT && (
      <div class="mt-8 w-full text-center">
        <button type="button" id="projects-toggle" data-open="false" class="mx-auto inline-flex items-center justify-center gap-2 rounded-md bg-gradient-to-r from-sky-400 via-cyan-500 to-blue-600 px-6 py-3 text-center font-jetbrains font-bold text-white transition-all duration-200 hover:brightness-110 hover:scale-105 hover:shadow-lg hover:shadow-sky-400/25 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2 focus:ring-offset-gray-900">
          <span id="projects-toggle-label">Show all</span>
          <svg id="projects-toggle-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5 transition-transform duration-300">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>
    )
  }

  <script is:inline>
    (() => {
      const items = Array.from(document.querySelectorAll(".project-item"));
      const btn = document.getElementById("projects-toggle");
      const label = document.getElementById("projects-toggle-label");
      const chevron = document.getElementById("projects-toggle-chevron");

      if (!btn || !label || items.length === 0) return;

      const applyState = (open) => {
        btn.dataset.open = open ? "true" : "false";
        label.textContent = open ? "showLess();" : "showAll();";
        chevron?.classList.toggle("rotate-180", open);

        items.forEach((el) => {
          const isPreview = el.getAttribute("data-preview") === "true";
          el.style.display = open || isPreview ? "" : "none";
        });
      };

      // show previews only
      applyState(false);

      btn.addEventListener("click", () => {
        const open = btn.dataset.open === "true";
        applyState(!open);

        // collapsed, scroll back nicely
        if (open) {
          document.getElementById("projects")?.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });

      document.addEventListener("astro:after-swap", () => applyState(false));
    })();
  </script>
</section>
